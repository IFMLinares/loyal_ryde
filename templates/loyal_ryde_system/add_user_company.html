{% extends "loyal_ryde_system/base/base.html" %} 
{% load static %} 

{% block title %}Agregar usuario de emprersas{% endblock title %}

{% block extra_css %} 

<link href="{% static 'assets/plugins/custom/datatables/datatables.bundle.css' %}" rel="stylesheet" type="text/css" />
{% endblock extra_css %}

{% block content %}

<div class="post d-flex flex-column-fluid" id="kt_post">
    <!--begin::Container-->
    <div id="kt_content_container" class="container-xxl">
        <form  class="form d-flex flex-column flex-lg-row" method="post">
            <!--begin::Aside column-->
            <div class="d-flex flex-column gap-7 gap-lg-10 w-100 w-lg-300px mb-7 me-lg-10">
                <!--begin::Thumbnail settings-->
                <div class="card card-flush py-4">
                    <!--begin::Card header-->
                    <div class="card-header">
                        <!--begin::Card title-->
                        <div class="card-title text-center">
                            <h2>Logo de la empresa</h2>
                        </div>
                        <!--end::Card title-->
                    </div>
                    <!--end::Card header-->
                    <!--begin::Card body-->
                    <div class="card-body text-center pt-0">
                        <!--begin::Image input-->
                        <div class="image-input image-input-empty image-input-outline mb-3" data-kt-image-input="true" style="background-image: url({% static 'assets/media/svg/files/blank-image.svg'%})" id="image_company">
                            <!--begin::Preview existing avatar-->
                            <div class="image-input-wrapper w-150px h-150px"></div>
                            <!--end::Preview existing avatar-->
                            <!--begin::Label-->
                            <!--end::Label-->
                            <!--begin::Cancel-->
                            <!--end::Cancel-->
                            <!--begin::Remove-->
                            <!--end::Remove-->
                        </div>
                        <!--end::Image input-->
                        <!--begin::Description-->
                        <!--end::Description-->
                    </div>
                    <!--end::Card body-->
                </div>
                <!--end::Thumbnail settings-->
                <!--begin::Status-->
                <div class="card card-flush py-4">
                    <!--begin::Card header-->
                    <div class="card-header">
                        <!--begin::Card title-->
                        <div class="card-title">
                            <h2>Empresa</h2>
                        </div>
                        <!--end::Card title-->
                        <!--begin::Card toolbar-->
                        <div class="card-toolbar">
                            <div class="rounded-circle bg-success w-15px h-15px" id="kt_ecommerce_add_category_status"></div>
                        </div>
                        <!--begin::Card toolbar-->
                    </div>
                    <!--end::Card header-->
                    <!--begin::Card body-->
                    <div class="card-body pt-0">
                        <!--begin::Select2-->
                        {{ form.company }}
                        <!--end::Select2-->
                        <!--begin::Description-->
                        <div class="text-muted fs-7">Seleccione la empresa a la que pertenece el usuario.</div>
                        <!--end::Description-->
                        <!--begin::Datepicker-->
                        <div class="d-none mt-10">
                            <label for="kt_ecommerce_add_category_status_datepicker" class="form-label">Seleccione la empresa a la que pertenece el usuario</label>
                            <input class="form-control" id="kt_ecommerce_add_category_status_datepicker" placeholder="Pick date &amp; time" />
                        </div>
                        <!--end::Datepicker-->
                    </div>
                    <!--end::Card body-->
                </div>
                <!--end::Status-->
                <!--begin::Status-->
                <!-- <div class="card card-flush py-4">
                    <div class="card-header">
                        <div class="card-title">
                            <h2>Estatus del Usuario</h2>
                        </div>
                        <div class="card-toolbar">
                            <div class="rounded-circle bg-success w-15px h-15px" id="kt_ecommerce_add_category_status"></div>
                        </div>
                    </div>
                    <div class="card-body pt-0">
                        {{ form.status }}
                        <div class="text-muted fs-7">Seleccione el estatus del usuario.</div>
                        <div class="d-none mt-10">
                            <label for="kt_ecommerce_add_category_status_datepicker" class="form-label">{{ form.status.label }}</label>
                            <input class="form-control" id="kt_ecommerce_add_category_status_datepicker" placeholder="Pick date &amp; time" />
                        </div>
                    </div>
                </div> -->
                
                <div class="card card-flush py-4">
                    <!--begin::Card header-->
                    <div class="card-header">
                        <!--begin::Card title-->
                        <div class="card-title">
                            <h2>Rol del Usuario</h2>
                        </div>
                        <!--end::Card title-->
                        <!--begin::Card toolbar-->
                        <div class="card-toolbar">
                            <div class="rounded-circle bg-success w-15px h-15px" id="kt_ecommerce_add_category_status"></div>
                        </div>
                        <!--begin::Card toolbar-->
                    </div>
                    <!--end::Card header-->
                    <!--begin::Card body-->
                    <div class="card-body pt-0">
                        <!--begin::Select2-->
                        {{ form.role }}
                        <!--end::Select2-->
                        <!--begin::Description-->
                        <div class="text-muted fs-7">Seleccione el rol del usuario.</div>
                        <!--end::Description-->
                        <!--begin::Datepicker-->
                        <div class="d-none mt-10">
                            <label for="kt_ecommerce_add_category_status_datepicker" class="form-label">{{ form.role.label }}</label>
                            <input class="form-control" id="kt_ecommerce_add_category_status_datepicker" placeholder="Pick date &amp; time" />
                        </div>
                        <!--end::Datepicker-->
                    </div>
                    <!--end::Card body-->
                </div>
                <!--end::Status-->
            </div>
            <!--end::Aside column-->
            <!--begin::Main column-->
            <div class="d-flex flex-column flex-row-fluid gap-7 gap-lg-10">
                <!--begin::General options-->
                <div class="card card-flush py-4">
                    <!--begin::Card header-->
                    <div class="card-header">
                        <div class="card-title">
                            <h2>Registrar Usuario: Empresas</h2>
                        </div>
                    </div>
                    <!--end::Card header-->
                    <!--begin::Card body-->
                    <div class="card-body pt-0">
                        <!--begin::Input group-->
                        {% csrf_token %}
                        
                        <div class="mb-3 fv-row">
                            <div class="row">
                                <div class="col-md-6 mb-3">
                                    <!--begin::Label-->
                                    <label class="required form-label">{{ form.first_name.label }}</label>
                                    <!--end::Label-->
                                    <!--begin::Input-->
                                    {{ form.first_name }}
                                    <!--end::Input-->
                                    <!--begin::Description-->
                                    <div class="text-muted fs-7">
                                        {{ form.first_name.help_text }}
                                    </div>
                                </div>
                                <div class="col-md-6 mb-3">
                                    <!--begin::Label-->
                                    <label class="required form-label">{{ form.last_name.label }}</label>
                                    <!--end::Label-->
                                    <!--begin::Input-->
                                    {{ form.last_name }}
                                    <!--end::Input-->
                                    <!--begin::Description-->
                                    <div class="text-muted fs-7">
                                        {{ form.last_name.help_text }}
                                    </div>
                                </div>
                            </div>
                                <!--end::Description-->
                            {% for field in form.visible_fields %}
                                {% if  field.name != 'role' and field.name != 'first_name' and field.name != 'last_name' and field.name != 'travel_approval' and field.name != 'company' %}
                                            <!--begin::Label-->
                                            {% if field.name == 'password1' or field.name == 'password2' %} 
                                            {% else %}
                                            <div class="mb-3  ">
                                            <label class="required form-label">{{ field.label }}</label>
                                            <!--end::Label-->
                                            <!--begin::Input-->
                                            {{ field }}
                                            {% if field.errors %}
                                                {% for error in field.errors %}
                                                    <div class="alert alert-danger" role="alert">
                                                        {{ error }}
                                                    </div>
                                                {% endfor %}
                                            {% endif %}
                                            <!--end::Input-->
                                            <!--begin::Description-->
                                            <div class="text-muted fs-7">
                                                {{ field.help_text }}
                                            </div>
                                            <!--end::Description-->
                                        </div>
                                        {% endif %}
                                {% endif %}
                            {% endfor %}
                            <input type="hidden" name="password1" value="asdhadjkshakds">
                            <input type="hidden" name="password2" value="asdhadjkshakds">
                            <div class="mb-3 d-none" id="travel_approval_div">
                            <label class="required form-label">¿{{ form.travel_approval.label }}?</label>
                            {{ form.travel_approval }}
                            <div class="text-muted fs-7">
                                {{ form.travel_approval.help_text }}
                            </div>
                        </div>
                            
                        </div>
                        <!--end::Input group-->
                    </div>
                    <!--end::Card header-->
                </div>
                <div class="d-flex justify-content-end">
                    <a href="{% url 'core:companies_list' %}" id="kt_ecommerce_add_product_cancel" class="btn btn-light me-5">Cancelar</a>

                    <button type="submit" class="btn btn-primary">
                        <span class="indicator-label">Guardar</span>
                        <span class="indicator-progress">
                        <span class="spinner-border spinner-border-sm align-middle ms-2"></span></span>
                    </button>
                </div>



            </div>
        </form>
    </div>
    <!--end::Container-->
</div>
{% endblock content %} 

{% block extra_js %} 
<script src="{% static 'assets/plugins/custom/datatables/datatables.bundle.js' %}"></script>
<script src="{% static 'assets/plugins/custom/formrepeater/formrepeater.bundle.js' %}"></script>
<!--end::Page Vendors Javascript-->
<!--begin::Page Custom Javascript(used by this page)-->
<script src="{% static 'assets/js/custom/apps/ecommerce/catalog/save-category.js' %}"></script>
<script src="{% static 'assets/js/widgets.bundle.js' %}"></script>
<script src="{% static 'assets/js/custom/widgets.js' %}"></script>
<script src="{% static 'assets/js/custom/apps/chat/chat.js' %}"></script>
<script src="{% static 'assets/js/custom/utilities/modals/upgrade-plan.js' %}"></script>
<script src="{% static 'ssets/js/custom/utilities/modals/create-app.js' %}"></script>
<script src="{% static 'assets/js/custom/utilities/modals/users-search.js' %}"></script>

<script>
    $('#password1, #password2').val('asdjhsdjhsdjhsjdh')
    $('#id_role option[value="conductor"]').prop('disabled', true);
    $('#id_role option[value="administrador"]').prop('disabled', true);
    $('#id_role option[value="despachador"]').prop('disabled', true);
    
    $('#id_role').change(function() {
    if ($(this).val() == 'supervisor') {
        $('#travel_approval_div').removeClass('d-none');
    } else {
        $('#travel_approval_div').addClass('d-none');
    }
});

function getCompanyImage() {
    var companyId = $('#id_company').val();  // El select tiene el id 'id_company'
    $.ajax({
        url: "{% url 'core:company_image' %}",  // La URL de tu vista en Django
        data: {
            'company_id': companyId
        },
        dataType: 'json',
        success: function (data) {
            console.log(data)
            $('#image_company').css('background-image', "{% static 'assets/media/svg/files/blank-image.svg'%}");
            $('#image_company').css('background-image', 'url(' + data.image_url + ')');
            // $('#company_image').attr('src', data.image_url);  // Asumiendo que tienes un img con el id 'company_image'
        }
    });
}

// Asegúrate de llamar a getCompanyImage() cuando el select cambie
$('#id_company').change(getCompanyImage);

try {
    getCompanyImage();
} catch (e) {
    // no hacer nada ya que se busca la imagen en la carga del update
}

</script>
<!--end::Page Custom Javascript-->
{% endblock extra_js %}
